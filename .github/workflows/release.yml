name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build universal binary
        run: |
          swift build -c release --arch arm64 --arch x86_64
          mkdir -p dist
          cp .build/apple/Products/Release/optipix dist/

      - name: Verify binary
        run: |
          file dist/optipix
          dist/optipix --version
          lipo -info dist/optipix

      - name: Code sign
        if: env.SIGNING_IDENTITY != ''
        env:
          SIGNING_IDENTITY: ${{ secrets.SIGNING_IDENTITY }}
        run: codesign --sign "$SIGNING_IDENTITY" --options runtime dist/optipix

      - name: Create archive
        run: |
          cd dist
          tar -czf optipix-${{ steps.version.outputs.VERSION }}-macos-universal.tar.gz optipix
          zip -j optipix-${{ steps.version.outputs.VERSION }}-macos-universal.zip optipix
          shasum -a 256 optipix-${{ steps.version.outputs.VERSION }}-macos-universal.tar.gz > optipix-${{ steps.version.outputs.VERSION }}-macos-universal.tar.gz.sha256
          shasum -a 256 optipix-${{ steps.version.outputs.VERSION }}-macos-universal.zip > optipix-${{ steps.version.outputs.VERSION }}-macos-universal.zip.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/optipix-${{ steps.version.outputs.VERSION }}-macos-universal.tar.gz
            dist/optipix-${{ steps.version.outputs.VERSION }}-macos-universal.tar.gz.sha256
            dist/optipix-${{ steps.version.outputs.VERSION }}-macos-universal.zip
            dist/optipix-${{ steps.version.outputs.VERSION }}-macos-universal.zip.sha256
